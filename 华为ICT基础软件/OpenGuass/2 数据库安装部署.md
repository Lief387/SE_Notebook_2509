您好，我已经根据您提供的 "第2章 数据库安装部署" 的学习资料，整理完成了对应的Markdown笔记。这份笔记涵盖了从环境准备到安装、配置、启停、连接、运维工具介绍及最终卸载的全过程。
# 2. 数据库安装部署
## 安装流程与环境准备
#### **openGauss 完整安装流程**
openGauss 的安装是一个标准化的流程，遵循以下步骤：
`安装前准备` -> `获取安装包` -> `配置XML文件` -> `上传并解压` -> `初始化环境` -> `执行安装` -> `（可选）设置备机`

> **> 直观理解/设计目的**
> 安装 openGauss 就像是按照图纸（XML配置文件）组装一台精密的服务器。首先，你需要准备好一个符合标准的工作间（操作系统环境），然后拿到所有零件（安装包），接着严格按照图纸上的指示进行组装（执行安装脚本），最后开机测试（启停与连接）。每一步都至关重要。

#### **硬件与软件环境要求**
在开始安装前，必须确保服务器满足特定的软硬件要求。

**1. 硬件要求 (Hardware Requirements)**

| 资源 (Resource)    | 功能调试建议 (Dev/Test)                  | 生产部署建议 (Production)                           |
| :----------------- | :--------------------------------------- | :-------------------------------------------------- |
| **内存 (Memory)**  | `32GB` 以上                              | `128GB` 以上                                        |
| **CPU**            | 1 x 8核 2.0GHz                           | 1 x 16核 2.0GHz                                     |
| **硬盘 (Disk)**    | 至少 `1GB` 应用空间 + `300MB` 元数据空间 | 系统盘 `RAID1`, 数据盘 `RAID5`，预留 `70%` 以上空间 |
| **网络 (Network)** | 千兆以太网                               | 万兆以太网，建议双网卡`bond`                        |

**2. 软件环境要求 (Software Requirements)**

| 分类 (Category)   | 要求 (Requirement)                                           |
| :---------------- | :----------------------------------------------------------- |
| **操作系统 (OS)** | openEuler 20.03 LTS, CentOS 7.6 (建议使用英文版)             |
| **Python 版本**   | Python 3.6.x 或 3.7.x                                        |
| **依赖包**        | `libaio-devel`, `flex`, `bison`, `ncurses-devel`, `glibc-devel`, `patch`, `readline-devel` |

## 操作系统配置

为了保证 openGauss 稳定运行，需要对操作系统进行一系列基础配置。**以下所有操作均需在 `root` 用户下执行，并在所有数据库节点上重复。**

#### **关闭防火墙和 SELinux**

> **> 直观理解/设计目的**
> 防火墙和 SELinux 是系统的安全卫士，但它们可能会阻止数据库集群节点间的正常通信。在安全的内网环境中，安装时通常会先关闭它们，以确保安装过程顺畅。

**1. 关闭 SELinux**
```bash
# 永久关闭SELinux
vim /etc/selinux/config
# 将 SELINUX=enforcing 修改为 SELINUX=disabled
SELINUX=disabled

# 修改后需要重启操作系统才能生效
reboot
```

**2. 关闭防火墙**
```bash
# 检查防火墙状态
systemctl status firewalld

# 如果是 active (running) 状态，则关闭并禁用
systemctl stop firewalld.service
systemctl disable firewalld.service
```

#### **配置字符集、时区和时间**
确保所有节点的字符集、时区和时间完全一致，这是集群正常工作的基础。

```bash
# 1. 设置字符集为 en_US.UTF-8
vim /etc/profile
# 在文件末尾添加
export LANG=en_US.UTF-8

# 使配置生效
source /etc/profile

# 2. 检查并统一各节点时间
date

# 3. (如果需要) 设置时区为亚洲/上海
cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
```

#### **设置 `root` 用户远程登录 (SSH)**
安装脚本需要在节点间通过 `root` 用户执行命令，因此需要开启 `root` 的SSH登录权限。

```bash
# 1. 编辑SSH配置文件
vim /etc/ssh/sshd_config

# 2. 修改或添加以下行，允许root登录
PermitRootLogin yes
# 注释掉 Banner 行，防止欢迎信息干扰脚本执行
# Banner /etc/issue

# 3. 重启sshd服务使配置生效
systemctl restart sshd.service
```

## 安装用户与用户组

出于安全考虑，openGauss 的安装和运行不应使用 `root` 用户，而是需要创建一个专用的普通用户（如 `omm`）和用户组（如 `dbgrp`）。

> **> 直观理解/设计目的**
> 这遵循了“最小权限原则”。就像你不会把整栋大楼的万能钥匙交给保洁员一样。只给 `omm` 用户管理数据库所必需的权限，可以极大地降低误操作或被攻击时对整个操作系统的影响。

#### **实践示例/操作步骤**
```bash
# 以 root 用户执行
# 1. 创建用户组
groupadd dbgrp

# 2. 创建用户并将其加入用户组
useradd -g dbgrp omm

# 3. 为新用户设置密码
passwd omm
```

## 安装 openGauss

安装过程主要由 `gs_preinstall` (环境预检查与配置) 和 `gs_install` (执行安装) 两个核心脚本完成。为简化流程，新版安装包提供了 `install.sh` 脚本，它封装了预检查和安装的完整流程。

#### **单节点安装**

**1. 准备安装包和配置文件**
   - 从官网下载 openGauss 安装包，例如 `openGauss-x.x.x-openEuler-64bit.tar.bz2`。
   - 上传安装包到服务器，例如 `/opt/software` 目录。

**2. 解压并执行安装**
```bash
# 切换到 omm 用户
su - omm

# 假定安装包在 /opt/software 目录下
# 1. 解压安装包到指定目录，例如 /opt/software/openGauss
tar -jxf /opt/software/openGauss-x.x.x-openEuler-64bit.tar.bz2 -C /opt/software/openGauss

# 2. 进入解压后的 simpleInstall 目录
cd /opt/software/openGauss/simpleInstall

# 3. 执行安装脚本，-w 参数设置数据库omm用户的初始密码（需符合复杂度要求）
sh install.sh -w "YourComplexPassword@123"
```

**3. 验证安装**
```bash
# 1. 查看 gaussdb 进程是否存在
ps ux | grep gaussdb

# 2. 使用 gs_ctl 工具查询实例状态
# -D 参数指定数据目录
gs_ctl query -D /opt/software/openGauss/data/single_node
# 如果 HA state 显示 Normal，则表示状态正常
```

#### **一主一备安装**
主备安装与单节点安装流程类似，但需要在 `install.sh` 脚本中增加 `--multinode` 参数，并通过XML配置文件来定义集群拓扑。

> **> 直观理解/设计目的**
> 单节点安装就像建了一座独立的房子，而主备安装则是建了两座一模一样的房子（主房和备房），并用一条专线（数据同步）连接起来。当主房出问题时，可以立刻启用备房，保证业务不中断。

*（注：教材中一主一备的安装步骤简化为使用`--multinode`参数，实际企业级安装通常需要手动编写`cluster_config.xml`文件，这里遵循教材的简化流程。）*

**1. 执行安装**
在主节点上，以 `omm` 用户执行：
```bash
cd /opt/software/openGauss/simpleInstall
# 增加 --multinode 参数
sh install.sh -w "YourComplexPassword@123" --multinode
```
*(脚本会自动处理备节点的配置和启动)*

**2. 验证安装**
在主节点上执行：
```bash
# 1. 查看进程，会看到主备两个gaussdb进程
ps ux | grep gaussdb

# 2. 查看主节点状态
gs_ctl query -D /opt/software/openGauss/data/master
# local_role 应显示为 Primary

# 3. 在备节点上执行，查看备节点状态
gs_ctl query -D /opt/software/openGauss/data/slave
# local_role 应显示为 Standby
```

## 数据库启停与连接

#### **数据库启停**
数据库的启停由 **`gs_om`** 工具统一管理。

> **> 直观理解/设计目的**
> `gs_om` (Gauss Operation Manager) 是集群的总管家，负责安全地启动和关闭整个数据库集群，确保所有组件协调一致地工作或停止。

```bash
# 以 omm 用户在主节点执行
# 启动集群
gs_om -t start

# 停止集群
gs_om -t stop
```

#### **客户端连接与认证**
**1. 本地连接**
使用 **`gsql`** 工具进行连接。
```bash
# 以 omm 用户执行
# -d 指定数据库名, -p 指定端口号
gsql -d postgres -p 8000/5432```

**2. 远程连接与白名单配置**
默认情况下，openGauss 只允许本地连接。要开启远程连接，必须修改 `pg_hba.conf` 文件，添加授权规则。这个操作可以通过 **`gs_guc`** 工具完成。

> **> 直观理解/设计目的**
> `pg_hba.conf` 就像是数据库大楼的门禁系统。`gs_guc` (Gauss Grand Unified Configuration) 则是配置这个门禁系统的遥控器。你必须明确告诉门禁系统：“允许IP地址为192.168.1.100的访客（用户jack）通过密码验证（sha256）进入”，他才能成功访问。

​```bash
# 以 omm 用户执行
# 允许 IP 为 10.10.0.30 的客户端以 jack 用户身份通过 sha256 密码验证连接所有数据库
gs_guc set -N all -I all -h "host all jack 10.10.0.30/32 sha256"
```

配置白名单后，在客户端机器上安装`gsql`客户端工具包，并执行远程连接命令：
```bash
# 在客户端机器上执行
gsql -d postgres -h 10.10.0.11 -U jack -p 8000 -W Test@123
```

## 关键运维工具介绍

openGauss 提供了一套丰富的命令行工具，方便DBA进行日常管理和维护。

| 工具名称 (Tool)     | 核心功能 (Function)                                          |
| :------------------ | :----------------------------------------------------------- |
| **`gs_preinstall`** | (已封装) 在安装数据库前，对操作系统环境进行检查和配置。      |
| **`gs_install`**    | (已封装) 根据XML配置文件，执行数据库的安装和部署。           |
| **`gs_ctl`**        | **实例级**管理工具，用于启动、停止、查询**单个**数据库实例的状态。 |
| **`gs_om`**         | **集群级**管理工具，用于启动、停止、查询整个数据库**集群**的状态。 |
| **`gsql`**          | 命令行客户端，用于连接数据库并执行SQL交互。                  |
| **`gs_guc`**        | 统一配置工具，用于读取和修改 `postgresql.conf` 和 `pg_hba.conf` 中的参数。 |
| **`gs_dump`**       | 逻辑备份工具，用于导出一个数据库的数据和对象定义。           |
| **`gs_restore`**    | 逻辑恢复工具，用于将 `gs_dump` 生成的备份文件恢复到数据库中。 |
| **`gs_check`**      | 巡检工具，用于全面检查数据库集群的运行状态和健康度。         |

## 数据库卸载

#### **执行卸载**
使用 `gs_uninstall` 脚本可以完整地卸载 openGauss，并清理相关的数据和环境配置。

```bash
# 以 omm 用户在主节点执行
# --delete-data 选项会删除所有数据文件，请谨慎操作！
gs_uninstall --delete-data
```

#### **一键式环境清理**
卸载后，如果希望将操作系统环境恢复到安装 openGauss 之前的状态（例如移除 `omm` 用户、清理内核参数等），可以执行 `gs_postuninstall` 脚本。

```bash
# 以 root 用户执行
# 该脚本位于解压后的 script 目录中
cd /path/to/opengauss/script
./gs_postuninstall -U omm -G dbgrp --delete-user
```